@model List<CartItem>

@{
    ViewData["Title"] = "- Cart";
    var TotalPrice = ViewBag.TotalPrice;
    var TotalDiscount = ViewBag.TotalDiscount;
    var SubTotal = ViewBag.SubTotal;
    List<int> idList = new List<int>();
}
<div class="cart-page-container">

    <div class="cart-items-list">
        <h2>My Cart</h2>
        @foreach (var cartItem in Model)
        {
            var game = cartItem.Game;
            idList.Add(game.Id);
            <div class="cart-item-card">
                <div class="item-details">
                    <div class="item-image" style="background-image: url('@game.BgImageUrl');">
                    </div>

                    <div class="item-info">
                        <a asp-controller="Game" asp-action="Detail"asp-route-slug="@game.Slug" class="item-title">
                            @game.Title
                        </a>
                    </div>
                    
                </div>
                <div class="item-action-price-section">
                    
                    <div class="item-price-section">
                        @if (game.DiscountPercent > 0)
                        {
                            <span class="discount-percent"> -@game.DiscountPercent% </span>

                            <span class="original-price">
                                @game.Price?.ToString("C")
                            </span>
                        }

                        <span class="final-price">@((game.Price * (1 - (decimal)(game.DiscountPercent ?? 0) / 100))?.ToString("C")) </span>
                    </div>
                    

                    <form asp-controller="Payment" asp-action="Remove" method="post" style="display: contents">
                        <input type="hidden" name="cartItemId" value="@cartItem.Id" />
                        <button type="submit" class="remove-button">Remove</button>
                    </form>
                </div>
            </div>
        }
    </div>

    <div class="order-summary">
        <h3>Game Summary</h3>

        <div class="summary-line">
            <span>Price</span>
            <span>@TotalPrice.ToString("C")</span> 
        </div>

        <div class="summary-line discount">
            <span>Discount</span>
            <span>@TotalDiscount.ToString("C")</span>
        </div>

        <div class="summary-line taxes">
            <span>Taxes</span>
            <span>Calculated at Checkout</span>
        </div>

        <div class="subtotal-section">
            <span class="subtotal-label">Subtotal</span>
            <span class="subtotal-value">@SubTotal.ToString("C")</span>
        </div>

        <button class="action-button yellow-button" style="width: 100% ; justify-content: center" onclick="showCheckoutPopup()">
            Checkout
        </button>
    </div>
</div>


<div id="paymentModal" class="payment-modal">
    <div class="payment-modal-content">
        
        <span class="close-payment" onclick="closeCheckoutPopup()">&times;</span>
        
        <div class="checkout-container">
            
            <div class="checkout-section">
                
                <h2 class="section-title">CHECKOUT</h2>
                <div class="progress-bar"></div>
                
                <h3 class="subsection-title">OTHER PAYMENT METHODS</h3>
                
                <label class="payment-option">
                    <input type="radio" name="payment_method" value="credit_card" checked>
                    <span class="option-text">Credit Card / Debit Card</span>
                </label>
                
                <label class="payment-option">
                    <input type="radio" name="payment_method" value="paypal">
                    <span class="option-text">PayPal</span>
                </label>
            </div>

            <div class="summary-section">
                <h3 class="summary-title">ORDER SUMMARY</h3>
                @foreach (var cartItem in Model)
                {
                    var game = cartItem.Game;
                    <div class="product-info">
                        <div class="product-image-placeholder" style="background-image: url(@game.BgImageUrl)"></div>
                        <div class="product-details">
                            <p class="game-name">@game.Title</p>
                            <div class="item-price-section">
                                @if (game.DiscountPercent > 0)
                                {
                                    <span class="discount-percent"> -@game.DiscountPercent% </span>

                                    <span class="original-game-price">
                                        @game.Price?.ToString("C")
                                    </span>
                                }

                                <span class="game-price">@((game.Price * (1 - (decimal)(game.DiscountPercent ?? 0) / 100))?.ToString("C")) </span>
                            </div>
                        </div>
                    </div>
                }
                

                <div class="price-breakdown">
                    <p><span>Price</span> <span>@TotalPrice.ToString("C")</span></p>
                    <p><span>Sale Discount</span> <span>@TotalDiscount.ToString("C")</span></p>
                    <p><span>VAT Included (10%)</span> <span>@((SubTotal * 1/11).ToString("C"))</span></p>
                    <hr>
                    <p class="total"><span>Total</span> <span>@SubTotal.ToString("C")</span></p>
                </div>
                
                <div class="creator-code">
                    <input type="text" placeholder="Enter creator code">
                    <span class="info-icon">?</span>
                </div>

                <p class="need-help">Need Help? <a href="#">Contact Us</a></p>
                
                <div class="terms-text">
                    <p>You are purchasing a digital license for this product. For full terms, see <a href="#">purchase policy</a>.</p>
                    <p>By selecting Place Order below, you certify that you are over 18 and an authorized user of this payment method, and agree to the <a href="#">End User License Agreement</a>.</p>
                </div>
                <form asp-controller="Payment" asp-action="PlaceOrder" method="post" style="display:contents;" >
                    @for (int i = 0; i < idList.Count; i++)
                    {
                        <input type="hidden" name="gameIds" value="@idList[i]" />
                    }

                    <button type="submit" class="action-button yellow-button" style="width:100%; justify-content: center">
                        PLACE ORDER
                    </button>
                </form>
            </div>
        </div>
        
    </div>
</div>

<script>
    // Popup thanh toan
    var modal = document.getElementById("paymentModal");

    function showCheckoutPopup() {
        // console.log("Đang mở thanh toán cho Game ID:", gameId); 

        modal.style.display = "block";
    }

    function closeCheckoutPopup() {
        modal.style.display = "none";
    }


    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
</script>
<style>.cart-page-container {

        max-width: 65vw;
        margin: auto;
        margin-top: 100px;
        padding: 40px 20px;

        display: flex;
        justify-content: space-between;
        color: #ffffff;
    }
    
    .cart-items-list {
        flex-grow: 1;
        margin-right: 15px;
    }

    .cart-item-card {
        margin: 20px;
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        padding: 20px 0;
        border-bottom: 1px solid #333;
        background-color: #242424;
        border-radius: 4px;
    }

    .item-details {
        display: flex;
        align-items: flex-start;
    }

    .item-title {
        font-size: 1.1em;
        font-weight: bold;
        color: #ffffff;
        text-decoration: none;
    }
    
    .item-title:hover {
        text-decoration: underline;
        color: #ffffff;
    }


    .item-price-section {
        display: flex;
        align-items: center;
        margin-bottom: 10px; /* Khoảng cách với nút Remove */
    }



    .order-summary {
        width: 300px;
        padding: 20px;
        border-radius: 6px;
    }

    .summary-line {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        font-size: 0.95em;
    }

    .subtotal-section {
        display: flex;
        justify-content: space-between;
        padding-top: 15px;
        margin-top: 15px;
        margin-bottom: 5px;
        border-top: 1px solid #333;
        font-size: 1.2em;
        font-weight: bold;
    }
    .remove-button {
        background: none;
        border: none;
        color: #ffffff; 
        cursor: pointer;
        padding: 0;
        font-size: 0.9em;
        text-transform: none;
        opacity: 0.7;
        transition: opacity 0.2s;
    }

    .remove-button:hover {
        opacity: 1;
        text-decoration: underline; /* Thêm gạch chân khi hover */
    }
</style>