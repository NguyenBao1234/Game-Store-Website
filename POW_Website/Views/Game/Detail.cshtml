@model POWStudio.Models.ViewModels.GameDetailModel
@{
    ViewData["Title"] = "- " + @Model.Game.Title;
    var screenshots = ViewBag.Screenshots;
    if (screenshots == null) screenshots = new List<string>(); //esure not null
    int judgedRating = ViewBag.JudgedRating;
    string judgedRatingString = ViewBag.JudgedRatingString;
    bool bOwned = ViewBag.bOwned;
    decimal gamePrice = @Model.Game.Price ?? 0.00m;
    decimal discountPrice = gamePrice * (decimal)((Model.Game.DiscountPercent ?? 0 )/ 100);
    decimal finalPrice = gamePrice - discountPrice;
    bool bGameInCart = ViewBag.bGameInCart;
    bool bGameInWishlist = ViewBag.bGameInWishlist;
    
}

<div class="position-relative overflow-hidden">
    <div class="content-card" style="background-image: url('@Model.Game.BgImageUrl')">
        <div class="center-content-wrapper">

            <div>
                <img style="object-fit: cover;  width: 100%" src="@Model.Game.TitleImageUrl"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
                <h1 style="display: none;font-size: 5em; font-weight: bold">@Model.Game.Title</h1>
            </div>

            <div class="d-flex gap-3 mt-3">
                @if (!string.IsNullOrEmpty(@Model.Game.ItchioUrl))
                {
                    <a href="@Model.Game.ItchioUrl" target="_blank" class="store-link">
                        <img src="https://static.itch.io/images/logo-white-new.svg"
                             alt="Itch.io" class="store-icon itch-icon" />
                    </a>
                }

                @if (!string.IsNullOrEmpty(Model.Game.EpicUrl))
                {
                    <a href="@Model.Game.EpicUrl" target="_blank" class="store-link">
                        <img src="https://commons.wikimedia.org/wiki/Special:Redirect/file/Epic_Games_Store_logo_2023_horizontal_white.svg"
                             alt="Epic Games" class="store-icon epic-icon" />
                    </a>
                }

                @if (!string.IsNullOrEmpty(Model.Game.SteamUrl))
                {
                    <a href="@Model.Game.SteamUrl" target="_blank" class="store-link">
                        <img src="https://store.cloudflare.steamstatic.com/public/shared/images/header/logo_steam.svg?t=962016"
                             alt="Steam" class="store-icon steam-icon" />
                    </a>
                }
                @if (!string.IsNullOrEmpty(Model.Game.FabUrl))
                {
                    <a href="@Model.Game.FabUrl" target="_blank" class="store-link">
                        <img src="https://static.fab.com/static/builds/web/dist/frontend/assets/images/common/logo/e1e12dc6142410b391ce48e416261ad7-v1.svg"
                             alt="Fab" class="store-icon fab-icon" />
                    </a>
                }
            </div>

            <div class="action-price-container mt-4 mb-4">

                <div class="price-display me-4">
                    @if (gamePrice == 0.00m)
                    {
                        <span class="price-label">Giá:</span>
                        <span class="price-value">FREE</span>
                    }
                    else
                    {
                        <span class="price-label">Price:</span>
                        <div class="item-price-section">
                            @if (Model.Game.DiscountPercent > 0)
                            {
                                <span class="discount-percent"> -@Model.Game.DiscountPercent% </span>

                                <span class="original-price">
                                    @Model.Game.Price?.ToString("C")
                                </span>
                            }

                            <span class="final-price">@((Model.Game.Price * (1 - (decimal)(Model.Game.DiscountPercent ?? 0) / 100))?.ToString("C")) </span>
                        </div>
                    }
                </div>

                @if (bOwned)
                {
                    <a>
                        <button class="action-button yellow-button" onclick="playGame(@Model.Game.Id)">
                            <i class="bi bi-controller me-2"></i> PLAY NOW
                        </button>
                    </a>
                }

                else if (gamePrice == 0.00m)
                {
                    <a>
                        <button class="action-button yellow-button" onclick="addToLibrary(@Model.Game.Id)">
                            <i class="bi bi-plus-circle me-2"></i> ADD TO LIBRARY
                        </button>
                    </a>
                }
                else
                {
                    <a>
                        <button class="action-button yellow-button" onclick="showCheckoutPopup(@Model.Game.Id)">BUY NOW
                        </button>
                    </a>
                    @if (bGameInWishlist)
                    {
                        <a asp-controller="Game" asp-action="Wishlist">
                            <button class="sub-button " >
                                <i class="bi bi-bookmark-check-fill"></i> 
                            </button>
                        </a>
                    }
                    else
                    {
                        <form asp-controller="Game" asp-action="AddToWishlistFromDetail" asp-route-gameId="@Model.Game.Id" style="display:contents;" >
                            <input type="hidden" name="gameId" value="@Model.Game.Id" />
                            <button class="sub-button">
                                <i class="bi bi-bookmark-plus-fill"></i>
                            </button>
                        </form>
                    }

                    @if (bGameInCart)
                    {
                        <a asp-controller="Payment" asp-action="Cart">
                            <button class="sub-button " >
                                <i class="bi bi-cart-check-fill"></i> 
                            </button>
                        </a>

                    }
                    else
                    {
                        <form asp-controller="Payment" asp-action="AddToCart" method="post" style="display:contents;">
                            <input type="hidden" name="gameId" value="@Model.Game.Id" />

                            <button class="sub-button">
                                <i class="bi bi-cart-fill"></i>
                            </button>
                        </form>
                    }
                }
            </div>
        </div>
        
    </div>
    
    <a class="scrollCaretButton" style="bottom: 10px; z-index: 3;" onclick="smoothScrollTo(document.getElementById('nextSection'))">
        <div class="caret-wrapper"><div class = "caret-icon"></div></div>
    </a>
</div>
<div id = "nextSection" class="centered-text-container">
    <h2>@Model.Game.ShortDescription</h2>
    <p>@Model.Game.DetailedDescription</p>
</div>

<div style="display: flex; justify-content: center; align-items: center; width: 100%;">
    @if (@Model.Game.bPublic)
    {
        <div style="width: 73vw; aspect-ratio: 16 / 9;">
            <iframe
                src="@Model.Game.TrailerUrl"
                allowfullscreen
                style="width: 100%; height: 100%; border: none; display: block; margin: auto;">
            </iframe>
        </div>
    }
    else
    {
        <div style="width: 73vw; aspect-ratio: 16 / 9; display: flex; justify-content: center; align-items: center;">
            <h1 style="font-size: 3em; color: #666; text-align: center;">Project will be public later</h1>
        </div>
    }
</div>

@if (screenshots.Count > 0)
{
    <div class="container my-5">

        <div id="gameThumbnailCarousel" class="carousel slide thumbnail-carousel" data-bs-ride="carousel" data-bs-interval="false">
            <div class="carousel-inner">
                <div class="carousel-item active">
                    <div class="d-flex justify-content-start align-items-center">
                        @for (int i = 0; i < screenshots.Count; i++)
                        {
                            string imagePath = screenshots[i];
                            <img src="@imagePath" 
                                 class="d-block thumbnail-image" 
                                 alt="Screenshot @(i + 1)" 
                                 data-bs-toggle="modal" 
                                 data-bs-target="#imageModal" 
                                 data-index="@i">
                        }
                    </div>
                </div>
            </div>
            
            <button class="carousel-control-prev" type="button" data-bs-target="#gameThumbnailCarousel" data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#gameThumbnailCarousel" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Next</span>
            </button>
        </div>
    </div>
}

@{
    int rating = ViewBag.JudgedRating;
    string ratingText = ViewBag.JudgedRatingString;

    // Sử dụng class màu sắc đã định nghĩa
    string colorClass = rating switch
    {
        0    => "text-secondary",
        1    => "text-danger-emphasis",      // Rất tệ
        2    => "text-danger",             // Tệ
        3    => "text-warning",            // Khá tệ
        4    => "text-secondary",          // Mixed
        5    => "text-info",               // Khá tốt
        6    => "text-primary",            // Tốt
        >= 7 => "text-success",            // Rất tốt
    };
}
<style>
.thumbnail-carousel .carousel-inner {
    overflow-x: auto; 
    overflow-y: hidden; 
    white-space: nowrap; 
    height: 120px; 
    display: block; 
}

.thumbnail-carousel .carousel-item {
    display: inline-block;
    width: auto;
}

.thumbnail-image {
    width: 200px; 
    height: 100px; 
    object-fit: cover; 
    margin-right: 8px; 
    cursor: pointer; 
    border: 2px solid transparent;
    transition: border-color 0.2s;
    border-radius: 4px;
    user-select: none;
}

.thumbnail-image:hover {
    border-color: #ffffff;
}

/* Modal */
#imageModal .modal-content {
    background-color: #000;
    border: none;
}

#imageModal .modal-dialog {
    max-width: none;
    width: 100%;
    margin: 0;
}

#imageModal .modal-body {
    background-color: #000;
    text-align: center;
}

#imageModal .carousel-item img {
    height: 90vh; 
    width: 100%;
    object-fit: contain;
    margin-top: 5vh; 
    display: block;
    user-select: none;
}

#imageModal .btn-close {
    filter: invert(1);
    opacity: 1;
}

/* Container chứa Giá và Nút */
.action-price-container {
    display: flex;
    align-items: center;
    gap: 20px; /* Khoảng cách giữa giá và nút */
    padding: 15px 25px; /* Đệm xung quanh */
    background-color: rgba(0, 0, 0, 0.4); /* Nền mờ nhẹ nhàng */
    border-radius: 8px; /* Bo góc */
    border: 1px solid rgba(255, 255, 255, 0.1); /* Viền mờ */
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
}

/* Phần hiển thị Giá */
.price-display {
    text-align: left;
    min-width: 150px; /* Đảm bảo đủ không gian cho giá tiền */
}

.price-label {
    display: block;
    font-size: 0.9em;
    color: rgba(255, 255, 255, 0.7);
    text-transform: uppercase;
    margin-bottom: 2px;
}

.price-value {
    font-family: 'Josefin Sans', sans-serif; 
    font-size: 2.2em; /* Giá to và rõ ràng hơn */
    font-weight: bold;
    color: #ffffff;
    line-height: 1;
}

/* Đảm bảo Icon có kích thước phù hợp */

/* Nút Giỏ hàng nhỏ (Add to Cart / View Cart) */
.add-to-cart-button {
    background-color: #333; /* Màu mặc định khi CHƯA có trong giỏ */
    color: white;
    width: 50px;
    height: 50px;
    border: none;
    border-radius: 8px;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 20px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

/* Cải thiện liên kết cửa hàng cho nhất quán hơn */
.store-link {
    display: flex;
    align-items: center;
    padding: 5px 10px;
    border-radius: 5px;
    background-color: rgba(255, 255, 255, 0.1);
    transition: background-color 0.2s;
}
.store-link:hover {
    background-color: rgba(255, 255, 255, 0.2);
}
.store-icon {
    height: 30px; /* Kích thước đồng nhất */
    filter: brightness(1);
}

</style>


<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-fullscreen-md-down">
        <div class="modal-content">
            <div class="modal-body p-0">
                <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" data-bs-dismiss="modal" aria-label="Close" style="z-index: 3"></button>

                <div id="fullImageCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-interval="false">
                    <div class="carousel-inner">
                        </div>

                    <button class="carousel-control-prev" type="button" data-bs-target="#fullImageCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#fullImageCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                </div>

            </div>
        </div>
    </div>
</div>

<div id="paymentModal" class="payment-modal">
    <div class="payment-modal-content">
        
        <span class="close-payment" onclick="closeCheckoutPopup()">&times;</span>
        
        <div class="checkout-container">
            
            <div class="checkout-section">
                
                <h2 class="section-title">CHECKOUT</h2>
                <div class="progress-bar"></div>
                
                <h3 class="subsection-title">OTHER PAYMENT METHODS</h3>
                
                <label class="payment-option">
                    <input type="radio" name="payment_method" value="credit_card" checked>
                    <span class="option-text">Credit Card / Debit Card</span>
                </label>
                
                <label class="payment-option">
                    <input type="radio" name="payment_method" value="paypal">
                    <span class="option-text">PayPal</span>
                </label>
            </div>

            <div class="summary-section">
                <h3 class="summary-title">ORDER SUMMARY</h3>
                
                <div class="product-info">
                    <div class="product-image-placeholder" style="background-image: url(@Model.Game.BgImageUrl)"></div>
                    <div class="product-details">
                        <p class="game-name">@Model.Game.Title</p>
                        <div class="item-price-section">
                            @if (Model.Game.DiscountPercent > 0)
                            {
                                <span class="discount-percent"> -@Model.Game.DiscountPercent% </span>

                                <span class="original-game-price">
                                    @Model.Game.Price?.ToString("C")
                                </span>
                            }

                            <span class="game-price">@((Model.Game.Price * (1 - (decimal)(Model.Game.DiscountPercent ?? 0) / 100))?.ToString("C")) </span>
                        </div>
                    </div>
                </div>

                <div class="price-breakdown">
                    <p><span>Price</span> <span>@gamePrice.ToString("C")</span></p>
                    <p><span>Sale Discount</span> <span>@discountPrice.ToString("C")</span></p>
                    <p><span>VAT Included (10%)</span> <span>@((finalPrice * 1/11).ToString("C"))</span></p>
                    <hr>
                    <p class="total"><span>Total</span> <span>@finalPrice.ToString("C")</span></p>
                </div>
                
                <div class="creator-code">
                    <input type="text" placeholder="Enter creator code">
                    <span class="info-icon">?</span>
                </div>

                <p class="need-help">Need Help? <a href="#">Contact Us</a></p>
                
                <div class="terms-text">
                    <p>You are purchasing a digital license for this product. For full terms, see <a href="#">purchase policy</a>.</p>
                    <p>By selecting Place Order below, you certify that you are over 18 and an authorized user of this payment method, and agree to the <a href="#">End User License Agreement</a>.</p>
                </div>
                @{
                    List<int> games = [Model.Game.Id]; 
                }
                <a asp-controller="Payment" asp-action="PlaceOrder" asp-route-gameIds="@games" class="action-button yellow-button" style="width: 100% ; justify-content: center">PLACE ORDER</a>
            </div>
        </div>
        
    </div>
</div>

<script>

const fullImages = @Html.Raw(Json.Serialize(screenshots));// convert img url C# (ViewBag) into JavaScript

document.addEventListener('DOMContentLoaded', function () 
{
    if (fullImages.length === 0) return; 

    const imageModal = document.getElementById('imageModal');
    const fullImageCarousel = document.getElementById('fullImageCarousel');
    const fullImageCarouselInner = fullImageCarousel.querySelector('.carousel-inner');

    // 1. register click callback on all thumbnail ele
    document.querySelectorAll('.thumbnail-image').forEach(thumbnail => {
        thumbnail.addEventListener('click', function() {
            const startIndex = parseInt(this.getAttribute('data-index'));

            // 2. Xây dựng nội dung carousel ảnh lớn trong Modal
            let carouselHTML = '';
            fullImages.forEach((src, index) => {
                const activeClass = index === startIndex ? 'active' : '';
                carouselHTML += `
                    <div class="carousel-item ${activeClass}">
                        <img src="${src}" class="d-block" alt="Full Screenshot ${index + 1}">
                    </div>
                `;
            });

            fullImageCarouselInner.innerHTML = carouselHTML;

            // Mở Modal và chuyển đến ảnh đã chọn (Sử dụng Bootstrap JS)
            let modal = bootstrap.Modal.getInstance(imageModal);
            if (!modal) modal = new bootstrap.Modal(imageModal);

            modal.show();
            
            // Khởi tạo hoặc lấy instance của Carousel và chuyển đến ảnh đã chọn
            const bsCarousel = bootstrap.Carousel.getInstance(fullImageCarousel);
            if (bsCarousel) bsCarousel.to(startIndex); 
            else new bootstrap.Carousel(fullImageCarousel).to(startIndex);
        });
    });
});

// Popup thanh toan
var modal = document.getElementById("paymentModal");

function showCheckoutPopup(gameId) {
    // Nếu bạn cần lấy thông tin gameId để hiển thị trong modal:
    // console.log("Đang mở thanh toán cho Game ID:", gameId); 

    modal.style.display = "block";
}

function closeCheckoutPopup() {
    modal.style.display = "none";
}


window.onclick = function(event) {
    if (event.target == modal) {
        modal.style.display = "none";
    }
}
</script>

