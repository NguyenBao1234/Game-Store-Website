@using Microsoft.IdentityModel.Tokens
@model POWStudio.Models.ViewModels.GameDetailVM
@{
    ViewData["Title"] = "- " + @Model.Game.Title;
    var screenshots = ViewBag.Screenshots;
    if (screenshots == null) screenshots = new List<string>(); //esure not null
    int judgedRating = ViewBag.JudgedRating;
    string judgedRatingString = ViewBag.JudgedRatingString;
    int ratingAmount = ViewBag.RatingAmount;
    bool bOwned = ViewBag.bOwned;
    decimal gamePrice = @Model.Game.Price ?? 0.00m;
    decimal discountPrice = gamePrice * (decimal)((Model.Game.DiscountPercent ?? 0 )/ 100);
    decimal finalPrice = gamePrice - discountPrice;
    bool bUserRated = ViewBag.bUserRated;
    bool bGameInCart = ViewBag.bGameInCart;
    bool bGameInWishlist = ViewBag.bGameInWishlist;

    string colorClass = judgedRating switch
    {
        0    => "text-secondary",
        1    => "text-danger-emphasis",      // Rất tệ
        2    => "text-danger",             // Tệ
        3    => "text-warning",            // Khá tệ
        4    => "text-secondary",          // Mixed
        5    => "text-info",               // Khá tốt
        6    => "text-primary",            // Tốt
        >= 7 => "text-success",            // Rất tốt
    };
    
}

<div class="position-relative overflow-hidden">
    <div class="content-card" style="background-image: url('@Model.Game.BgImageUrl')">
        <div class="center-content-wrapper">

            <div>
                <img style="object-fit: cover;  width: 100%" src="@Model.Game.TitleImageUrl"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
                <h1 style="display: none;font-size: 5em; font-weight: bold">@Model.Game.Title</h1>
            </div>

            <div class="d-flex gap-3 mt-3">
                @if (!string.IsNullOrEmpty(@Model.Game.ItchioUrl))
                {
                    <a href="@Model.Game.ItchioUrl" target="_blank" class="store-link">
                        <img src="https://static.itch.io/images/logo-white-new.svg"
                             alt="Itch.io" class="store-icon itch-icon" />
                    </a>
                }

                @if (!string.IsNullOrEmpty(Model.Game.EpicUrl))
                {
                    <a href="@Model.Game.EpicUrl" target="_blank" class="store-link">
                        <img src="https://commons.wikimedia.org/wiki/Special:Redirect/file/Epic_Games_Store_logo_2023_horizontal_white.svg"
                             alt="Epic Games" class="store-icon epic-icon" />
                    </a>
                }

                @if (!string.IsNullOrEmpty(Model.Game.SteamUrl))
                {
                    <a href="@Model.Game.SteamUrl" target="_blank" class="store-link">
                        <img src="https://store.cloudflare.steamstatic.com/public/shared/images/header/logo_steam.svg?t=962016"
                             alt="Steam" class="store-icon steam-icon" />
                    </a>
                }
                @if (!string.IsNullOrEmpty(Model.Game.FabUrl))
                {
                    <a href="@Model.Game.FabUrl" target="_blank" class="store-link">
                        <img src="https://static.fab.com/static/builds/web/dist/frontend/assets/images/common/logo/e1e12dc6142410b391ce48e416261ad7-v1.svg"
                             alt="Fab" class="store-icon fab-icon" />
                    </a>
                }
            </div>

            <div class="action-price-container mt-4 mb-4">
                
                <div class="rating-badge-section pe-3 border-end border-secondary border-opacity-25">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-star-fill @colorClass me-2 fs-5"></i>
                        <div class="d-flex flex-column">
                            <span class="fw-bold @colorClass" style="line-height: 1.2; font-size: 0.9rem;">
                                @judgedRatingString.ToUpper()
                            </span>
                            <span class="text-white-50" style="font-size: 0.75rem;">
                                (@ratingAmount Reviews)
                            </span>
                        </div>
                    </div>
                </div>
                
                @if (!bOwned)
                {
                    <div class="price-display me-4">
                        @if (gamePrice == 0.00m)
                        {
                            <span class="price-label">Price:</span>
                            <span class="price-value">FREE</span>
                        }
                        else
                        {
                            <span class="price-label">Price:</span>
                            <div class="item-price-section">
                                @if (Model.Game.DiscountPercent > 0)
                                {
                                    <span class="discount-percent"> -@Model.Game.DiscountPercent% </span>

                                    <span class="original-price">
                                        @Model.Game.Price?.ToString("C")
                                    </span>
                                }

                                <span class="final-price">@((Model.Game.Price * (1 - (decimal)(Model.Game.DiscountPercent ?? 0) / 100))?.ToString("C")) </span>
                            </div>
                        }
                    </div>
                }
                @if (bOwned)
                {
                    <button class="sub-action-button @(bUserRated ? "active-gold" : "")" id="RateBtn">
                        @if (bUserRated)
                        {
                            <i class="bi bi-star-fill me-2 text-warning"></i>
                            <span>EDIT RATING</span>
                        }
                        else
                        {
                            <i class="bi bi-star me-2"></i>
                            <span>RATE</span>
                        }
                    </button>
                    <a style="text-decoration: none" href="https://drive.usercontent.google.com/download?id=1rr9H8LLo5nFbWQjYct-GUYXlct9mPJnR&export=download&authuser=0&confirm=t&uuid=3957c54b-ed6a-443c-b15f-388532169645&at=ALWLOp4_hQ0r2vs3IGnfGObI4gcS:1763878211100" download>
                        <button class="action-button yellow-button" onclick="playGame(@Model.Game.Id)">
                            <i class="bi bi-controller me-2"></i> PLAY NOW
                        </button>
                    </a>
                }

                else if (gamePrice == 0.00m)
                {
                    <form asp-controller="Payment" asp-action="PlaceOrder" method="post" style="display:contents;">
                        <input type="hidden" name="gameIds" value="@Model.Game.Id"/>

                        <button type="submit" class="action-button yellow-button" style="width:100%; justify-content: center">
                            ADD TO LIBRARY
                        </button>
                    </form>
                }
                else
                {
                    <a>
                        <button class="action-button yellow-button" onclick="showCheckoutPopup(@Model.Game.Id)">BUY NOW
                        </button>
                    </a>
                    @if (bGameInWishlist)
                    {
                        <a asp-controller="Game" asp-action="Wishlist">
                            <button class="sub-button ">
                                <i class="bi bi-bookmark-check-fill"></i>
                            </button>
                        </a>
                    }
                    else
                    {
                        <form asp-controller="Game" asp-action="AddToWishlistFromDetail" asp-route-gameId="@Model.Game.Id" style="display:contents;">
                            <input type="hidden" name="gameId" value="@Model.Game.Id"/>
                            <button class="sub-button">
                                <i class="bi bi-bookmark-plus-fill"></i>
                            </button>
                        </form>
                    }

                    @if (bGameInCart)
                    {
                        <a asp-controller="Payment" asp-action="Cart">
                            <button class="sub-button ">
                                <i class="bi bi-cart-check-fill"></i>
                            </button>
                        </a>

                    }
                    else
                    {
                        <form asp-controller="Payment" asp-action="AddToCart" method="post" style="display:contents;">
                            <input type="hidden" name="gameId" value="@Model.Game.Id"/>

                            <button class="sub-button">
                                <i class="bi bi-cart-fill"></i>
                            </button>
                        </form>
                    }
                }
            </div>
        </div>
        
    </div>
    
    <a class="scrollCaretButton" style="bottom: 10px; z-index: 3;" onclick="smoothScrollTo(document.getElementById('nextSection'))">
        <div class="caret-wrapper"><div class = "caret-icon"></div></div>
    </a>
</div>
<div id = "nextSection" class="centered-content-container">
    <h2>@Model.Game.ShortDescription</h2>
    <p>@Model.Game.DetailedDescription</p>
</div>

<div style="display: flex; justify-content: center; align-items: center; width: 100%;">
    @if (@Model.Game.bPublic)
    {
        <div style="width: 73vw; aspect-ratio: 16 / 9;">
            <iframe
                src="@Model.Game.TrailerUrl"
                allowfullscreen
                style="width: 100%; height: 100%; border: none; display: block; margin: auto;">
            </iframe>
        </div>
    }
    else
    {
        <div style="width: 73vw; aspect-ratio: 16 / 9; display: flex; justify-content: center; align-items: center;">
            <h1 style="font-size: 3em; color: #666; text-align: center;">Project will be public later</h1>
        </div>
    }
</div>

@if (screenshots.Count > 0 && @Model.Game.bPublic)
{
    <div class="container my-5">

        <div id="gameThumbnailCarousel" class="carousel slide thumbnail-carousel" data-bs-ride="carousel" data-bs-interval="false">
            <div class="carousel-inner">
                <div class="carousel-item active">
                    <div class="d-flex justify-content-start align-items-center">
                        @for (int i = 0; i < screenshots.Count; i++)
                        {
                            string imagePath = screenshots[i];
                            <img src="@imagePath" 
                                 class="d-block thumbnail-image" 
                                 alt="Screenshot @(i + 1)" 
                                 data-bs-toggle="modal" 
                                 data-bs-target="#imageModal" 
                                 data-index="@i">
                        }
                    </div>
                </div>
            </div>
            
            <button class="carousel-control-prev" type="button" data-bs-target="#gameThumbnailCarousel" data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#gameThumbnailCarousel" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Next</span>
            </button>
        </div>
    </div>
}


<style>
.thumbnail-carousel .carousel-inner {
    overflow-x: auto; 
    overflow-y: hidden; 
    white-space: nowrap; 
    height: 120px; 
    display: block; 
}

.thumbnail-carousel .carousel-item {
    display: inline-block;
    width: auto;
}

.thumbnail-image {
    width: 200px; 
    height: 100px; 
    object-fit: cover; 
    margin-right: 8px; 
    cursor: pointer; 
    border: 2px solid transparent;
    transition: border-color 0.2s;
    border-radius: 4px;
    user-select: none;
}

.thumbnail-image:hover {
    border-color: #ffffff;
}

/* Modal */
#imageModal .modal-content {
    background-color: #000;
    border: none;
}

#imageModal .modal-dialog {
    max-width: none;
    width: 100%;
    margin: 0;
}

#imageModal .modal-body {
    background-color: #000;
    text-align: center;
}

#imageModal .carousel-item img {
    height: 90vh; 
    width: 100%;
    object-fit: contain;
    margin-top: 5vh; 
    display: block;
    user-select: none;
}

#imageModal .btn-close {
    filter: invert(1);
    opacity: 1;
}

/* Container chứa Giá và Nút */
.action-price-container {
    display: flex;
    align-items: center;
    gap: 20px; /* Khoảng cách giữa giá và nút */
    padding: 15px 25px; /* Đệm xung quanh */
    background-color: rgba(0, 0, 0, 0.4); /* Nền mờ nhẹ nhàng */
    border-radius: 8px; /* Bo góc */
    border: 1px solid rgba(255, 255, 255, 0.1); /* Viền mờ */
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
}

/* Phần hiển thị Giá */
.price-display {
    text-align: left;
    min-width: 150px; /* Đảm bảo đủ không gian cho giá tiền */
}

.price-label {
    display: block;
    font-size: 0.9em;
    color: rgba(255, 255, 255, 0.7);
    text-transform: uppercase;
    margin-bottom: 2px;
}

.price-value {
    font-family: 'Josefin Sans', sans-serif; 
    font-size: 2.2em; /* Giá to và rõ ràng hơn */
    font-weight: bold;
    color: #ffffff;
    line-height: 1;
}

/* Đảm bảo Icon có kích thước phù hợp */

/* Nút Giỏ hàng nhỏ (Add to Cart / View Cart) */
.add-to-cart-button {
    background-color: #333; /* Màu mặc định khi CHƯA có trong giỏ */
    color: white;
    width: 50px;
    height: 50px;
    border: none;
    border-radius: 8px;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 20px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

/* Cải thiện liên kết cửa hàng cho nhất quán hơn */
.store-link {
    display: flex;
    align-items: center;
    padding: 5px 10px;
    border-radius: 5px;
    background-color: rgba(255, 255, 255, 0.1);
    transition: background-color 0.2s;
}
.store-link:hover {
    background-color: rgba(255, 255, 255, 0.2);
}
.store-icon {
    height: 30px; /* Kích thước đồng nhất */
    filter: brightness(1);
}

</style>


<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-fullscreen-md-down">
        <div class="modal-content">
            <div class="modal-body p-0">
                <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" data-bs-dismiss="modal" aria-label="Close" style="z-index: 3"></button>

                <div id="fullImageCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-interval="false">
                    <div class="carousel-inner">
                        </div>

                    <button class="carousel-control-prev" type="button" data-bs-target="#fullImageCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#fullImageCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                </div>

            </div>
        </div>
    </div>
</div>

<div id="paymentModal" class="payment-modal">
    <div class="payment-modal-content">
        
        <span class="close-payment" onclick="closeCheckoutPopup()">&times;</span>
        
        <div class="checkout-container">
            
            <div class="checkout-section">
                
                <h2 class="section-title">CHECKOUT</h2>
                <div class="progress-bar"></div>
                
                <h3 class="subsection-title">OTHER PAYMENT METHODS</h3>
                
                <label class="payment-option">
                    <input type="radio" name="payment_method" value="credit_card" checked>
                    <span class="option-text">Credit Card / Debit Card</span>
                </label>
                
                <label class="payment-option">
                    <input type="radio" name="payment_method" value="paypal">
                    <span class="option-text">PayPal</span>
                </label>
            </div>

            <div class="summary-section">
                <h3 class="summary-title">ORDER SUMMARY</h3>
                
                <div class="product-info">
                    <div class="product-image-placeholder" style="background-image: url(@Model.Game.BgImageUrl)"></div>
                    <div class="product-details">
                        <p class="game-name">@Model.Game.Title</p>
                        <div class="item-price-section">
                            @if (Model.Game.DiscountPercent > 0)
                            {
                                <span class="discount-percent"> -@Model.Game.DiscountPercent% </span>

                                <span class="original-game-price">
                                    @Model.Game.Price?.ToString("C")
                                </span>
                            }

                            <span class="game-price">@((Model.Game.Price * (1 - (decimal)(Model.Game.DiscountPercent ?? 0) / 100))?.ToString("C")) </span>
                        </div>
                    </div>
                </div>

                <div class="price-breakdown">
                    <p><span>Price</span> <span>@gamePrice.ToString("C")</span></p>
                    <p><span>Sale Discount</span> <span>@discountPrice.ToString("C")</span></p>
                    <p><span>VAT Included (10%)</span> <span>@((finalPrice * 1/11).ToString("C"))</span></p>
                    <hr>
                    <p class="total"><span>Total</span> <span>@finalPrice.ToString("C")</span></p>
                </div>
                
                <div class="creator-code">
                    <input type="text" placeholder="Enter creator code">
                    <span class="info-icon">?</span>
                </div>

                <p class="need-help">Need Help? <a href="#">Contact Us</a></p>
                
                <div class="terms-text">
                    <p>You are purchasing a digital license for this product. For full terms, see <a href="#">purchase policy</a>.</p>
                    <p>By selecting Place Order below, you certify that you are over 18 and an authorized user of this payment method, and agree to the <a href="#">End User License Agreement</a>.</p>
                </div>
                @{
                    List<int> games = [Model.Game.Id];
                    foreach (var game in games)
                    {
                        Console.WriteLine("ID: "+ game);
                    }
                }
                <form asp-controller="Payment" asp-action="PlaceOrder" method="post" style="display:contents;" >
                    @for (int i = 0; i < games.Count; i++)
                    {
                        <input type="hidden" name="gameIds" value="@games[i]" />
                    }

                    <button type="submit" class="action-button yellow-button" style="width:100%; justify-content: center">
                        PLACE ORDER
                    </button>
                </form>
            </div>
        </div>
        
    </div>
</div>

<div class="modal fade" id="reviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background: #16120f; border: 1px solid #ffc107; color: #acb2b8;">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-white">WRITE A REVIEW</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="reviewForm">
                    <input type="hidden" name="GameId" value="@Model.Game.Id" />
                    
                    <label class="d-block mb-2 small text-uppercase fw-bold text-warning">Do you recommend this game?</label>
                    <div class="d-flex gap-3 mb-4">
                        <input type="radio" class="btn-check" name="bRecomended" id="recTrue" value="true" checked>
                        <label class="btn btn-outline-warning d-flex align-items-center gap-2 flex-fill py-2" for="recTrue">
                            <i class="bi bi-hand-thumbs-up-fill fs-4"></i> Yes
                        </label>

                        <input type="radio" class="btn-check" name="bRecomended" id="recFalse" value="false">
                        <label class="btn btn-outline-danger d-flex align-items-center gap-2 flex-fill py-2" for="recFalse">
                            <i class="bi bi-hand-thumbs-down-fill fs-4"></i> No
                        </label>
                    </div>

                    <div class="mb-3">
                        <label for="Comment" class="form-label small text-uppercase fw-bold text-warning">Your Review</label>
                        <textarea class="form-control" name="Comment" id="Comment" rows="5" 
                                  style="background: #000; color: #eee; border: 1px solid #333;" 
                                  placeholder="Describe what you liked or disliked about this game..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">CANCEL</button>
                <button type="button" class="btn btn-gold-outline px-4" id="submitReview">POST REVIEW</button>
            </div>
        </div>
    </div>
</div>

<script>

const fullImages = @Html.Raw(Json.Serialize(screenshots));// convert img url C# (ViewBag) into JavaScript

document.addEventListener('DOMContentLoaded', function () 
{
    if (fullImages.length === 0) return; 

    const imageModal = document.getElementById('imageModal');
    const fullImageCarousel = document.getElementById('fullImageCarousel');
    const fullImageCarouselInner = fullImageCarousel.querySelector('.carousel-inner');

    // 1. register click callback on all thumbnail ele
    document.querySelectorAll('.thumbnail-image').forEach(thumbnail => {
        thumbnail.addEventListener('click', function() {
            const startIndex = parseInt(this.getAttribute('data-index'));

            // 2. Xây dựng nội dung carousel ảnh lớn trong Modal
            let carouselHTML = '';
            fullImages.forEach((src, index) => {
                const activeClass = index === startIndex ? 'active' : '';
                carouselHTML += `
                    <div class="carousel-item ${activeClass}">
                        <img src="${src}" class="d-block" alt="Full Screenshot ${index + 1}">
                    </div>
                `;
            });

            fullImageCarouselInner.innerHTML = carouselHTML;

            // Mở Modal và chuyển đến ảnh đã chọn (Sử dụng Bootstrap JS)
            let modal = bootstrap.Modal.getInstance(imageModal);
            if (!modal) modal = new bootstrap.Modal(imageModal);

            modal.show();
            
            // Khởi tạo hoặc lấy instance của Carousel và chuyển đến ảnh đã chọn
            const bsCarousel = bootstrap.Carousel.getInstance(fullImageCarousel);
            if (bsCarousel) bsCarousel.to(startIndex); 
            else new bootstrap.Carousel(fullImageCarousel).to(startIndex);
        });
    });
});

// Popup thanh toan
var modal = document.getElementById("paymentModal");

function showCheckoutPopup(gameId) {
    // console.log("Đang mở thanh toán cho Game ID:", gameId); 

    modal.style.display = "block";
}

function closeCheckoutPopup() {
    modal.style.display = "none";
}


window.onclick = function(event) {
    if (event.target == modal) {
        modal.style.display = "none";
    }
}
</script>

<div class="reviews-container mt-5" style="background: #171717">
    
    <div class="centered-content-container">
        <h3 class="mb-4 text-white border-bottom border-warning pb-2" style="border-width: 2px !important;">
            <span style="color: #ffc107;">PLAYER</span> REVIEWS
        </h3>
        
        
        @if (!Model.Rates.IsNullOrEmpty())
        {
            <div class="filter-bar mb-4 p-3" style="background: #141414; border: 1px solid #333; border-radius: 4px;">
                <div class=" d-flex flex-wrap gap-2 align-items-center">
                    <span class="text-muted small me-2">FILTER BY:</span>
                    <button class="btn btn-gold-outline btn-sm filter-btn" data-group="filter" data-value="positive">Positive</button>
                    <button class="btn btn-gold-outline btn-sm filter-btn" data-group="filter" data-value="negative">Negative</button>
                    <button class="btn btn-gold-outline btn-sm filter-btn active-gold" data-group="filter" data-value="all">All</button>

                    <div class="vr mx-2" style="background-color: #444;"></div>

                    <span class="text-muted small me-2">SORT BY:</span>
                    <button class="btn btn-gold-outline btn-sm filter-btn active-gold" data-group="sort" data-value="date">Recent</button>
                    <button class="btn btn-gold-outline btn-sm filter-btn" data-group="sort" data-value="helpful">Helpful</button>
                    <button class="btn btn-gold-outline btn-sm filter-btn" data-group="sort" data-value="funny">Funny</button>
                </div>
            </div>
        }
        
        
        @if (Model.Rates.IsNullOrEmpty())
        {
            <div class="text-center p-5 mt-3" 
                 style="background: #111; border: 1px dashed #444; border-radius: 8px;">
        
                <div class="mb-3">
                    <i class="bi bi-chat-square-dots" style="font-size: 3rem; color: #333;"></i>
                </div>
        
                <h4 class="text-white">No reviews yet</h4>
                <p style="color: #777; max-width: 400px; margin: 0 auto;">
                    Be the first one to share your thoughts about this game with the community!
                </p>
                
            </div>
        }
        <div id="reviews-list-target">
            @foreach (var rate in Model.Rates)
            {
                <div class="review-card mb-4" style="background: #111; border: 1px solid #333; border-radius: 4px; border-left: 4px solid @(rate.bRecomended ? "#ffc107" : "#ff4444");">
                    <div class="row g-0">
                        <div class="col-md-3 p-3" style="background: rgba(255, 255, 255, 0.03);">
                            <div class="d-flex align-items-center mb-3">
                                <div class="avatar-placeholder me-2 d-flex align-items-center justify-content-center"
                                     style="width: 40px; height: 40px; border: 1px solid #ffc107; background: #000;">
                                    <i class="bi bi-person-fill" style="color: #ffc107;"></i>
                                </div>
                                <strong style="color: #eee;">@rate.User.DisplayName</strong>
                            </div>

                            <div class=" mb-2">
                                @if (rate.bRecomended)
                                {
                                    <div class="d-flex align-items-center" style="color: #ffc107;">
                                        <i class="bi bi-hand-thumbs-up-fill fs-4 me-2"></i>
                                        <span class="fw-bold small">RECOMMENDED</span>
                                    </div>
                                }
                                else
                                {
                                    <div class="d-flex align-items-center" style="color: #ff4444;">
                                        <i class="bi bi-hand-thumbs-down-fill fs-4 me-2"></i>
                                        <span class="fw-bold small">NOT RECOMMENDED</span>
                                    </div>
                                }
                            </div>
                            <div class="text-muted small">Posted: @rate.Date.ToString("MMM dd, yyyy")</div>
                        </div>

                        <div class="col-md-9 p-3 d-flex flex-column">
                            <div class=" mb-auto">
                                <p style="color: #ccc; white-space: pre-line; line-height: 1.6; font-size: 0.95rem;">
                                    @rate.Comment
                                </p>
                            </div>

                            <div class=" pt-3 mt-3" style="border-top: 1px solid #222;">
                                <div class="d-flex align-items-center flex-wrap gap-2">
                                    <span class="small text-muted me-2">Was this review helpful?</span>

                                    <button class="btn btn-gold-outline btn-sm" data-type="yes" onclick="sendReaction(@rate.Id, 'yes', this)">
                                        <i class="bi bi-hand-thumbs-up"></i> Yes (<span class="count">@(rate.LikeAmount ?? 0)</span>)
                                    </button>
    
                                    <button class="btn btn-gold-outline btn-sm" data-type="no" onclick="sendReaction(@rate.Id, 'no', this)">
                                        <i class="bi bi-hand-thumbs-down"></i> No (<span class="count">@(rate.DislikeAmount ?? 0)</span>)
                                    </button>
    
                                    <button class="btn btn-gold-outline btn-sm" data-type="funny" onclick="sendReaction(@rate.Id, 'funny', this)">
                                        <i class="bi bi-emoji-laughing"></i> Funny (<span class="count">@(rate.FunnyAmount ?? 0)</span>)
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }   
        </div>
        
    </div>
</div>
<style>
    .text-muted {
        color: #777 !important;
    }
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const filterButtons = document.querySelectorAll('.filter-btn');
    const targetContainer = document.getElementById('reviews-list-target');
    
    // Khởi tạo giá trị mặc định
    let currentFilter = 'all';
    let currentSort = 'date';
    const gameId = @ViewBag.GameId;

    filterButtons.forEach(btn => {
        btn.addEventListener('click', function () {
            const group = this.getAttribute('data-group');
            const value = this.getAttribute('data-value');

            // 1. Chỉ xóa active trong cùng một group
            document.querySelectorAll(`.filter-btn[data-group="${group}"]`).forEach(b => {
                b.classList.remove('active-gold');
            });
            this.classList.add('active-gold');

            // 2. Cập nhật biến trạng thái tương ứng
            if (group === 'filter') {
                currentFilter = value;
            } else {
                currentSort = value;
            }

            // 3. Gọi hàm fetch với cả 2 tham số
            fetchAndRender(currentFilter, currentSort);
        });
    });

    async function fetchAndRender(filter, sort) {
        targetContainer.innerHTML = `
            <div class="text-center p-5">
                <div class="spinner-border text-warning" role="status"></div>
                <p class="mt-2 text-warning fw-bold" style="letter-spacing: 2px;">LOADING...</p>
            </div>`;

        try {
            const formData = new FormData();
            formData.append('gameId', gameId);
            formData.append('filterBy', filter); // Gửi thêm loại filter (Positive/Negative/All)
            formData.append('sortBy', sort);     // Gửi loại sort (Date/Helpful/Funny)

            const response = await fetch('/Game/FilterReviews', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const data = await response.json();
                renderHTML(data);
            }
        } catch (error) {
            targetContainer.innerHTML = '<p class="text-danger text-center">Error loading reviews.</p>';
        }
    }

    function renderHTML(data) {
        if (!data || data.length === 0) {
            targetContainer.innerHTML = '<div class="text-center text-muted p-5">No reviews found for these criteria.</div>';
            return;
        }

        let html = '';
        data.forEach(rate => {
            const color = rate.isRecommended ? '#ffc107' : '#ff4444';
            const statusText = rate.isRecommended ? 'RECOMMENDED' : 'NOT RECOMMENDED';
            const icon = rate.isRecommended ? 'bi-hand-thumbs-up-fill' : 'bi-hand-thumbs-down-fill';

            html += `
            <div class="review-card mb-4" style="background: #111; border: 1px solid #333; border-radius: 4px; border-left: 4px solid ${color};">
                <div class="row g-0">
                    <div class="col-md-3 p-3" style="background: rgba(255, 255, 255, 0.03);">
                        <div class="d-flex align-items-center mb-3">
                            <div class="avatar-placeholder me-2 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; border: 1px solid #ffc107; background: #000;">
                                <i class="bi bi-person-fill" style="color: #ffc107;"></i>
                            </div>
                            <strong style="color: #eee;">${rate.userName}</strong>
                        </div>
                        <div class=" mb-2" style="color: ${color}">
                            <i class="bi ${icon} fs-4 me-2"></i>
                            <span class="fw-bold small">${statusText}</span>
                        </div>
                        <div class="text-muted small">Posted: ${rate.date}</div>
                    </div>
                    <div class="col-md-9 p-3 d-flex flex-column">
                        <div class=" mb-auto">
                            <p style="color: #ccc; white-space: pre-line; line-height: 1.6; font-size: 0.95rem;">${rate.comment}</p>
                        </div>
                        <div class=" pt-3 mt-3" style="border-top: 1px solid #222;">
                            <div class="d-flex align-items-center flex-wrap gap-2">
                                <span class="small text-muted me-2">Was this review helpful?</span>
                                <button class="btn btn-gold-outline btn-sm" data-type="yes" onclick="sendReaction(${rate.id}, 'yes', this)">
                                    <i class="bi bi-hand-thumbs-up"></i> Yes (<span class="count">${rate.likes}</span>)
                                </button>
    
                                <button class="btn btn-gold-outline btn-sm" data-type="no" onclick="sendReaction(${rate.id}, 'no', this)">
                                    <i class="bi bi-hand-thumbs-down"></i> No (<span class="count">${rate.dislikes}</span>)
                                </button>
    
                                <button class="btn btn-gold-outline btn-sm" data-type="funny" onclick="sendReaction(${rate.id}, 'funny', this)">
                                    <i class="bi bi-emoji-laughing"></i> Funny (<span class="count">${rate.funny}</span>)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        });
        targetContainer.innerHTML = html;
    }
    
});


async function sendReaction(reviewId, type, buttonElement) {
    const card = buttonElement.closest('.review-card');
    const allButtons = card.querySelectorAll('.btn-gold-outline');

    // Tìm xem trước đó user có đang chọn nút nào không (trong nhóm Yes/No)
    let previousBtn = null;
    if (type === 'yes' || type === 'no') {
        previousBtn = card.querySelector(`.btn-gold-outline.active-gold[data-type="yes"], .btn-gold-outline.active-gold[data-type="no"]`);
    } else {
        // Riêng nút Funny thì độc lập
        previousBtn = card.querySelector(`.btn-gold-outline.active-gold[data-type="funny"]`);
    }

    const isRemoving = buttonElement.classList.contains('active-gold');
    const previousType = (previousBtn && previousBtn !== buttonElement) ? previousBtn.getAttribute('data-type') : null;

    try {
        const formData = new FormData();
        formData.append('reviewId', reviewId);
        formData.append('reactionType', type);
        formData.append('isRemoving', isRemoving);
        if (previousType) formData.append('previousType', previousType);

        const response = await fetch('/Game/ReactToReview', { method: 'POST', body: formData });

        if (response.ok) {
            const data = await response.json();

            // Cập nhật lại số cho cả 3 nút trong card đó
            updateButtonUI(card, 'yes', data.likes);
            updateButtonUI(card, 'no', data.dislikes);
            updateButtonUI(card, 'funny', data.funny);

            // Cập nhật trạng thái Active
            if (isRemoving) {
                buttonElement.classList.remove('active-gold');
            } else {
                if (previousBtn) previousBtn.classList.remove('active-gold');
                buttonElement.classList.add('active-gold');
            }
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

function updateButtonUI(card, type, count) {
    const btn = card.querySelector(`button[data-type="${type}"]`);
    if (btn) {
        const span = btn.querySelector('.count');
        if (span) span.innerText = count;
    }
}
</script>


@* RATING FEATURE *@
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const rateBtn = document.getElementById('RateBtn');
        const reviewModal = new bootstrap.Modal(document.getElementById('reviewModal'));
        const submitBtn = document.getElementById('submitReview');

        // Biến trạng thái từ Razor truyền xuống JS (để hiển thị thông báo nếu cần)
        const isEditMode = @(bUserRated.ToString().ToLower());

        if (rateBtn) {
            rateBtn.addEventListener('click', function () {
                // Nếu là Edit, có thể thay đổi title modal cho khớp
                document.querySelector('.modal-title').innerText = isEditMode ? 'EDIT YOUR REVIEW' : 'WRITE A REVIEW';
                reviewModal.show();
            });
        }

        submitBtn.addEventListener('click', async function () {
            const form = document.getElementById('reviewForm');
            const formData = new FormData(form);

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> SAVING...';

            try {
                // Action PostReview bây giờ sẽ xử lý logic Upsert (Update if exist, else Insert)
                const response = await fetch('/Game/PostReview', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    location.reload(); // Reload để cập nhật lại nút và danh sách review
                } else {
                    alert("Error: Could not save your review.");
                }
            } catch (error) {
                console.error("Error:", error);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerText = 'POST REVIEW';
            }
        });
    });

    async function deleteReview(reviewId) {
        // 1. Xác nhận trước khi xóa
        if (!confirm("Are you sure you want to permanentely delete this review? This action cannot be undone.")) {
            return;
        }

        try {
            const formData = new FormData();
            formData.append('id', reviewId);

            const response = await fetch('/Admin/Rating/DeleteReview', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                // 2. Thông báo thành công (tùy chọn)
                console.log("Deleted successfully");

                // 3. Gọi lại hàm fetch hiện tại để cập nhật danh sách (giữ nguyên filter/sort đang chọn)
                // Biến currentFilter và currentSort đã được khai báo ở phạm vi global hoặc trong scope DOMContentLoaded của bạn
                fetchAdminReviews(currentFilter, currentSort);
            } else {
                alert("Error: Could not delete the review.");
            }
        } catch (error) {
            console.error("Error:", error);
            alert("An error occurred while trying to delete.");
        }
    }
</script>