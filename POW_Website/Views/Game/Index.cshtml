@using POWStudio.Models.Enum
<style>
    body {
        background-color: #121212;
        color: #e0e0e0;
    }

    /* Input group - border */
    .search-input-custom {
        border-radius: 50px; 
        overflow: hidden; /* để các thành phần bên trong bo tròn theo */
        border: 1px solid #333333; /* Viền nhẹ */
    }
    

    .search-icon-custom {
        background-color: #212121; 
        color: #999999;
        border: none;
        padding-left: 1rem;
        padding-right: 0.5rem;
        display: flex;
        align-items: center;
        font-size: 1.25rem;
    }
    
    .search-field-custom {
        background-color: #212121; /* dark theme  */
        color: white; /* input text color */
        border: none;
        padding: 1rem 1.5rem 1rem 0.5rem; /* Tăng padding để input trông to hơn */
        font-size: 1.1rem;
        height: 55px; 
    }

    /* remove focus border of Bootstrap when select field */
    .search-field-custom:focus {
        color: white;
        background-color: #212121;
        box-shadow: none;
    }
    .search-field-custom:-webkit-autofill,
    .search-field-custom:-webkit-autofill:hover,
    .search-field-custom:-webkit-autofill:focus {
        -webkit-text-fill-color: white !important;
        box-shadow: 0 0 0 1000px #212121 inset !important;
    }

    /* Màu nền chung (giả định) */
    body {
        background-color: #1a1a1a;
    }

    /* Kiểu dáng cho tiêu đề và Biểu tượng Caret */
    .header {
        cursor: pointer;
        color: #ffffff !important; /* Đảm bảo chữ trắng */
    }

    /* Ẩn checkbox mặc định */
    .checkbox-hidden {
        position: absolute;
        opacity: 0;
        cursor: pointer;
        height: 0;
        width: 0;
    }
    .genre-label {
        display: block;
        margin: 0;
        font-size: 0.9rem;
        line-height: 1.5;
        color: #a3a3a3 !important;
    }
    /* Kiểu dáng chung cho mỗi mục (Item) */
    .genre-item {
        cursor: pointer;
        border-radius: 4px;
        transition: background-color 0.1s;
        padding: 8px 0;
    }

    /*HOVER và SELECTED có màu giống nhau */
    .genre-item:hover {
        background-color: #333333;
    }

    .item-selected{
        background-color: #333333;
    }
    .item-selected .genre-label {
        color: #ffffff !important;
    }

    /* Price Input Price */
    .price-field {
        background-color: #333333;
        color: #ffffff;
        border: 1px solid #444444;
    }
    .price-field:focus {
        background-color: #333333; /* Giữ nguyên màu khi focus */
        color: #ffffff;
        border-color: rgba(0, 120, 242, 0); /* Có thể đổi màu border khi focus cho nổi bật */
        box-shadow: 0 0 0 0.25rem rgba(0, 120, 242, 0.25);
    }
    .price-field::placeholder {
        color: #999999;
    }
    .border-gray {
        border-color: #444444 !important;
    }
</style>
<script src="~/lib/jquery/dist/jquery.min.js"></script>

@{
    // Lấy giá trị SearchTerm từ ViewData
    string searchTerm = ViewData["CurrentSearchTerm"]?.ToString() ?? "";
    var sortOption = ViewData["SortOption"] ?? GameSortOption.All;
    bool sortAscending = ViewData["SortAscending"] as bool? ?? true;
    
    var allCategoryNames = ViewData["AllCategories"] as List<string> ?? new List<string>();
    var selectedCategoryNames = ViewData["SelectedCategories"] as List<string> ?? new List<string>();
    var minPrice = ViewData["MinPrice"] as decimal?;
    var maxPrice = ViewData["MaxPrice"] as decimal?;

}
<div class="container search-offset-top" style="margin-top: 100px; margin-bottom: 50px"> 
    
    <div class="row justify-content-center mb-5">
        <div class="col-lg-12 position-relative">
            <form asp-controller="Game" asp-action="Index" method="get" asp-route-term="">
                <div class="input-group search-input-custom">
                    <span class="input-group-text search-icon-custom">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text"
                           id="search-input"
                           name="inSearchTerm"
                           class="form-control search-field-custom"
                           placeholder="Search..."
                           value="@searchTerm">
                </div>
            </form>
            <div id="search-suggestions" class="suggestions-popup"></div>
        </div>
    </div>

    <div class="row">
        
        <div class="col-lg-3 order-lg-1 order-2">
            <h5 class="fw-bold mb-3">Filters</h5>
            
            <form asp-controller="Game" asp-action="Index" method="get" id="filter-form">
                
                <div class="mb-4 border-bottom border-gray pb-3 ">
                    <h6 class="fw-semibold mb-2 header text-light" 
                        data-bs-toggle="collapse" 
                        data-bs-target="#price-filter" 
                        aria-expanded="true">
                        Price Range
                        <i class="bi bi-chevron-down float-end"></i></h6>
                    
                    <div id="price-filter" class="collapse show">
                        <div class="row g-2">
                            <div class="col-6">
                                <input type="number" name="inMinPrice" class="form-control form-control-sm price-field" placeholder="Min" value="@minPrice?.ToString()">
                            </div>
                            <div class="col-6">
                                <input type="number" name="inMaxPrice" class="form-control form-control-sm price-field" placeholder="Max" value="@maxPrice?.ToString()">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-4 border-bottom border-gray pb-3 ">
                    <h6 class="fw-semibold mb-2 header text-light" 
                        data-bs-toggle="collapse" 
                        data-bs-target="#genre-filter" 
                        aria-expanded="true">
                        Genre
                        <i class="bi bi-chevron-down float-end"></i> </h6>
                    
                    <div id="genre-filter" class="collapse show">
                        <div class="genre-list">
                            @foreach (var categoryName in allCategoryNames)
                            {
                                // Item tùy chỉnh thay cho form-check
                                <div class="genre-item @(selectedCategoryNames.Contains(categoryName) ? "item-selected" : "")">
                                    <input class="checkbox-hidden" 
                                           type="checkbox" 
                                           name="inCategoryNames" 
                                           value="@categoryName" 
                                           id="cat-@categoryName"
                                           @(selectedCategoryNames.Contains(categoryName) ? "checked" : "")
                                           onchange="document.getElementById('filter-form').submit();"> 
                                    
                                    <label class="genre-label" for="cat-@categoryName">
                                        @categoryName
                                        @if (selectedCategoryNames.Contains(categoryName))
                                        {
                                            <i class="bi bi-check float-end"></i> }
                                    </label>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn btn-sm btn-primary w-100 mt-2">Apply Filters</button>
            </form>
            <a asp-controller="Game" asp-action="Index" class="btn btn-sm btn-outline-secondary w-100 mt-2">Reset Filters</a>
        </div>
        
        <div class="col-lg-9 order-lg-2 order-1">
            
            <div class="d-flex justify-content-start align-items-center mb-4">
                <form asp-controller="Game" asp-action="Index" method="get" id="sort-form" class="d-flex align-items-center">
                    
                    <input type="hidden" name="inSearchTerm" value="@searchTerm"/>
                    <input type="hidden" name="inMinPrice" value="@minPrice"/>
                    <input type="hidden" name="inMaxPrice" value="@maxPrice"/>
                    @foreach (var categoryName in selectedCategoryNames)
                    {
                        <input type="hidden" name="inCategoryNames" value="@categoryName"/>
                    }
                    
                    <input type="hidden" id="sort-by-input" name="inSortOption" value="@sortOption"/>
                    <input type="hidden" id="is-ascending-input" name="inSortAscending" value="@sortAscending.ToString()"/>
                    
                    <div class="dropdown me-2">
                        <button class="btn btn-dark dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Show: @sortOption
                        </button>
                        <ul class="dropdown-menu">
                            @foreach (var option in Enum.GetValues(typeof(GameSortOption)))
                            {
                                <li>
                                    <a class="dropdown-item" href="javascript:void(0)" onclick="selectSortOption('@option.ToString()')">
                                        @option.ToString()
                                    </a>
                                </li>
                            }
                        </ul>
                    </div>

                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-secondary @(sortAscending ? "active" : "")" onclick="setSortDirection(true)">
                            <i class="bi bi-arrow-up"></i> 
                        </button>
                        <button type="button" class="btn btn-outline-secondary @(!sortAscending ? "active" : "")" onclick="setSortDirection(false)">
                            <i class="bi bi-arrow-down"></i>
                        </button>
                    </div>

                </form>
            </div>
            
            <div class="game-grid" style="min-height: 60vh">
                @foreach (var game in Model)
                {
                    <div class="game-card">
                        <a asp-controller="Game" asp-action="Detail" asp-route-slug="@game.Slug" class="text-decoration-none text-white">
                            <img src="@game.BgImageUrl" alt="@game.Title" class="game-thumbnail"/>
                            <div class="game-info">
                                <h6 class="fw-semibold mb-1">@game.Title</h6>
                                <p class="small text-muted mb-2">@game.ShortDescription</p>
                                <p class="price mb-0">
                                    @if (game.Price == 0 || game.Price == null)
                                    {
                                        <span class="text-success">Free</span>
                                    }
                                    else
                                    {
                                        <span>@game.Price?.ToString("C")</span>
                                    }
                                </p>
                            </div>
                        </a>
                    </div>
                }
            </div>
        </div>
        
    </div>
    <hr style="margin-top: 25px; margin-bottom: 50px"/>
</div>
@* Script to enhance *@
<script>
    
$(document).ready(function()
{
    const $searchInput = $('#search-input');
    const $suggestions = $('#search-suggestions');
    let timer;

    // Hàm gọi AJAX sau khi người dùng ngừng gõ một chút (debounce)
    function fetchSuggestions(searchTerm) 
    {
        console.log("Fetching suggestions");
        $.ajax({
            url: '@Url.Action("SuggestGames", "Game")', 
            type: 'GET',
            data: { term: searchTerm },
            success: function(html) 
            {
                if (html.trim() !== "") 
                {
                    $suggestions.html(html).slideDown(150) // Cập nhật nội dung và hiển thị popup
                    $('.game-title').each(function() {
                        const originalText = $(this).attr('data-original-title');
                        $(this).html(highlight(originalText, searchTerm)); // Dùng searchTerm mới nhất từ JS
                    });

                    // Cập nhật link "View all results"
                    $('#view-all-results-link').attr('href', `/Game/Index?SearchTerm=${encodeURIComponent(searchTerm)}`);
                }
                else $suggestions.slideUp(150);
            },
            error: function() 
            {
                $suggestions.html('<div class="p-3 text-danger">Lỗi khi tải kết quả.</div>').slideDown(150);
            }
        });
    }

    // bind input event
    $searchInput.on('input', function()
    {
        const searchTerm = $(this).val().trim();
        
        // Xóa timer trước đó để tránh gọi nhiều lần
        clearTimeout(timer);

        if (searchTerm.length > 0) 
        { 
            // Đợi 250ms sau khi ngừng gõ để gọi AJAX
            timer = setTimeout(function() {
                fetchSuggestions(searchTerm);
            }, 200);
        } else $suggestions.slideUp(150);
    });
    
    // Xử lý khi người dùng click ra ngoài popup để ẩn nó
    $(document).on('click', function(e) {
        if (!$(e.target).closest('#search-form, #search-suggestions').length) {
            $suggestions.slideUp(150);
        }
    });
    
    // Xử lý khi bấm phím ESC để ẩn popup
    $(document).on('keydown', function(e) {
        if (e.key === "Escape") {
            $suggestions.slideUp(150);
            $searchInput.blur(); // Mất focus khỏi input
        }
    });
    
});
</script>

@section Scripts {
    <script>
        function selectSortOption(selectedSortOption) {
            console.log("Scripts:", selectedSortOption);
            document.getElementById('sort-by-input').value = selectedSortOption;
            document.getElementById('sort-form').submit(); // submit if change filter
        }

        function setSortDirection(isAscending) {
            document.getElementById('is-ascending-input').value = isAscending.toString();
            document.getElementById('sort-form').submit(); 
        }
    </script>
}
