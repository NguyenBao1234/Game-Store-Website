@using Microsoft.AspNetCore.Authorization
@model IEnumerable<POWStudio.Models.Game>
@inject POWStudio.Models.GameStoreDbContext mDbContext
@attribute [Authorize(Policy = "IsAdmin")]
@{
    ViewData["Title"] = "- Admin";
    var spotlightData = mDbContext.GameSpotlight.ToDictionary(s => s.GameId, s => s.Priority);
}
<div class="container py-5" style="margin-top: 100px" >
    
    <div class="text-center mb-5">
        <h1 class="text-white fw-bold mb-2" style="font-size: 2.5rem;">
            <i class="bi bi-person-workspace me-2 text-warning"></i> ADMIN MANAGER
        </h1>
    </div>

    <div class="row mb-3 g-2">
        <div class="col-md-4">
            <div class="input-group">
                <span class="input-group-text bg-dark border-secondary text-secondary"><i class="bi bi-search"></i></span>
                <input type="text" id="adminSearchInput" class="form-control bg-dark text-white border-secondary rounded-0" placeholder="Tìm kiếm tên game...">
            </div>
        </div>
    
        <div class="col-md-3">
            <select id="adminSortBy" class="form-select bg-dark text-white border-secondary rounded-0">
                <option value="id">Sort by: ID</option>
                <option value="name">Sort by: Name</option>
                <option value="date">Sort by: Released Date</option>
            </select>
        </div>

        <div class="col-md-3">
            <select id="adminSortOrder" class="form-select bg-dark text-white border-secondary rounded-0">
                <option value="asc">Ascending order (A-Z, Oldest)</option>
                <option value="desc">Decreasing order (Z-A, Latest)</option>
            </select>
        </div>
    </div>

    
    <div class="p-4 rounded-0" style="background-color: #1a1a1a; border: 1px solid #333;">
        
        <h3 class="text-white mb-3">Game List</h3>
        
        <table class="table table-dark table-hover table-bordered border-secondary" style="width: 100%;">
            <thead>
            <tr>
                <th scope="col" style="width: 5%;">ID</th>
                <th scope="col" style="width: 40%;">Name</th>
                <th scope="col" style="width: 15%;" class="text-center">Spotliht</th>
                <th scope="col" style="width: 15%;" class="text-center">Rating</th>
                <th scope="col" style="width: 15%;" class="text-center">Edit</th>
                <th scope="col" style="width: 15%;" class="text-center">Delete</th>
            </tr>
            </thead>
            <tbody>
            @foreach (var game in Model)
            {
                var isSpotlight = spotlightData.ContainsKey(game.Id);
                var priority = isSpotlight ? spotlightData[game.Id] : 0;
                    
                <tr id="game-row-@game.Id" data-id = "@game.Id" data-name="@game.Title" data-date="@game.ReleaseDate?.ToString("yyyy-MM-ddTHH:mm:ss")">
                    <th scope="row">@game.Id</th>
                    <td>@game.Title</td>
                    <td class="text-center">
                        @* Nút mở Modal *@
                        <button type="button" 
                                class="btn btn-sm @(isSpotlight ? "btn-warning" : "btn-outline-secondary") rounded-0 px-3 btn-spotlight"
                                style="width: 110px;"
                                data-game-id="@game.Id" 
                                data-game-title="@game.Title"
                                data-is-active="@isSpotlight.ToString().ToLower()"
                                data-priority="@priority">
                            <i class="bi @(isSpotlight ? "bi-star-fill" : "bi-star")"></i>
                            <span class="status-text">@(isSpotlight ? "Active" : "Deactive")</span>
                        </button>
                    </td>
                        
                    <td class="text-center">
                        <a class="btn btn-sm btn-outline-warning rounded-0 px-3" 
                           asp-controller="Admin" asp-action="Rating" asp-route-GameId="@game.Id">
                            Rating
                        </a>
                    </td>
                        
                    <td class="text-center">
                        <a class="btn btn-sm btn-outline-warning rounded-0 px-3" 
                           asp-controller="Admin" asp-action="EditGame" asp-route-id="@game.Id">
                            Edit
                        </a>
                    </td>
                        
                    <td class="text-center">
                        <a class="btn btn-sm btn-outline-danger rounded-0 px-3" 
                           asp-controller="Admin" asp-action="DeleteGame" asp-route-id="@game.Id">
                            Delete
                        </a>
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>

    <div class="mt-4 p-3 d-flex justify-content-end gap-3 rounded-0" style="background-color: #1a1a1a; border: 1px solid #333;">
        
        <a class="btn btn-warning btn-lg rounded-0 fw-bold" 
           asp-controller="Admin" asp-action="Order">
            <i class="bi bi-bag"></i> Order
        </a>
        
        <a class="btn btn-warning btn-lg rounded-0 fw-bold" 
           asp-controller="Admin" asp-action="AddGame">
            <i class="bi bi-plus-circle me-1"></i> Add New Game
        </a>
        
        <a class="btn btn-secondary btn-lg rounded-0 fw-bold" 
           asp-controller="Admin" asp-action="AddCategory">
            <i class="bi bi-tags me-1"></i> Add Category
        </a>
        
    </div>
</div>


<div class="modal fade" id="spotlightModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white border-secondary rounded-0">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Spotlight: <span id="modalGameTitle"></span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="modalGameId" />
                
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="modalIsSpotlight">
                    <label class="form-check-label" for="modalIsSpotlight">Display on Home's Spotlight</label>
                </div>

                <div id="priorityGroup" class="mb-3">
                    <label class="form-label text-warning">Priority - The highest number appears first.</label>
                    <input type="number" id="modalPriority" class="form-control bg-dark text-white border-secondary rounded-0" placeholder="0" />
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-outline-secondary rounded-0" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="btnSaveSpotlight" class="btn btn-warning rounded-0 px-4">Save change</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // 1. Khi bấm nút mở Modal
            $('.btn-spotlight').on('click', function () {
                const btn = $(this);
                const gameId = btn.data('game-id');
                const title = btn.data('game-title');
                const isActive = btn.data('is-active');
                const priority = btn.data('priority');

                $('#modalGameId').val(gameId);
                $('#modalGameTitle').text(title);
                $('#modalIsSpotlight').prop('checked', isActive);
                $('#modalPriority').val(priority);
                
                // Hiển thị/ẩn ô nhập Priority dựa trên checkbox
                togglePriorityInput(isActive);

                $('#spotlightModal').modal('show');
            });

            $('#modalIsSpotlight').on('change', function() {
                togglePriorityInput($(this).is(':checked'));
            });

            function togglePriorityInput(show) {
                if(show) $('#priorityGroup').fadeIn();
                else $('#priorityGroup').fadeOut();
            }

            // 2. Khi bấm Lưu (AJAX)
            $('#btnSaveSpotlight').on('click', function () {
                const data = {
                    gameId: parseInt($('#modalGameId').val()),
                    isActive: $('#modalIsSpotlight').is(':checked'),
                    priority: parseInt($('#modalPriority').val()) || 0
                };

                $.post('/Admin/UpdateSpotlight', data, function (response) {
                    if (response.success) {
                        // Cập nhật lại giao diện ngay lập tức mà không load trang
                        const btn = $(`.btn-spotlight[data-game-id="${data.gameId}"]`);
                        btn.data('is-active', data.isActive);
                        btn.data('priority', data.priority);

                        if (data.isActive) {
                            btn.removeClass('btn-outline-secondary').addClass('btn-warning');
                            btn.find('i').removeClass('bi-star').addClass('bi-star-fill');
                            btn.find('.status-text').text('Active');
                        } else {
                            btn.removeClass('btn-warning').addClass('btn-outline-secondary');
                            btn.find('i').removeClass('bi-star-fill').addClass('bi-star');
                            btn.find('.status-text').text('Deactive');
                        }

                        $('#spotlightModal').modal('hide');
                    } else {
                        alert("Có lỗi xảy ra: " + response.message);
                    }
                });
            });
        });

        document.addEventListener('DOMContentLoaded', function () {
            const searchInput = document.getElementById('adminSearchInput');
            const sortBy = document.getElementById('adminSortBy');
            const sortOrder = document.getElementById('adminSortOrder');
            const tableBody = document.querySelector('table tbody');

            // Lưu trữ danh sách các hàng gốc vào một mảng để xử lý
            const originalRows = Array.from(tableBody.querySelectorAll('tr'));

            function performFilterAndSort() {
                const searchTerm = searchInput.value.toLowerCase().trim();
                const sortByKey = sortBy.value; // 'name' hoặc 'date'
                const order = sortOrder.value; // 'asc' hoặc 'desc'

                // 1. Lọc theo tên
                let filteredRows = originalRows.filter(row => {
                    const name = row.getAttribute('data-name').toLowerCase();
                    const isMatch = name.includes(searchTerm);
                    row.style.display = isMatch ? '' : 'none'; // Ẩn/hiện hàng
                    return isMatch;
                });

                // 2. Sắp xếp
                filteredRows.sort((a, b) => {
                    let valA, valB;

                    if (sortByKey === 'id') {
                        // Ép kiểu về số để so sánh chính xác (tránh 10 < 2 nếu so sánh chuỗi)
                        valA = parseInt(a.getAttribute('data-id'));
                        valB = parseInt(b.getAttribute('data-id'));
                    } else if (sortByKey === 'name') {
                        valA = a.getAttribute('data-name').toLowerCase();
                        valB = b.getAttribute('data-name').toLowerCase();
                    } else {
                        // Sắp xếp theo ngày (chuyển chuỗi ISO thành giá trị thời gian để so sánh)
                        valA = new Date(a.getAttribute('data-date')).getTime();
                        valB = new Date(b.getAttribute('data-date')).getTime();
                    }

                    if (valA < valB) return order === 'asc' ? -1 : 1;
                    if (valA > valB) return order === 'asc' ? 1 : -1;
                    return 0;
                });

                // 3. Cập nhật lại giao diện
                // Fragment giúp tối ưu hóa việc chèn nhiều phần tử cùng lúc vào DOM
                const fragment = document.createDocumentFragment();
                filteredRows.forEach(row => fragment.appendChild(row));
                tableBody.appendChild(fragment);
            }

            // Lắng nghe sự kiện
            searchInput.addEventListener('input', performFilterAndSort);
            sortBy.addEventListener('change', performFilterAndSort);
            sortOrder.addEventListener('change', performFilterAndSort);
        });
    </script>
    
    
}

